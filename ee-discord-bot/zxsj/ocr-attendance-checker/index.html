<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>åˆ°å ´åå–®æª¢æŸ¥å™¨ï½œOCR</title>
<style>
  :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
  html,body {
    height:100%;
    background:var(--bg);
    color:var(--ink);
    font-family:"Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
  }

  .wrap{max-width:1200px;margin:20px auto;padding:16px}
  .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-bottom:16px}
  h1{font-size:22px;margin:0 0 8px}
  h2{font-size:18px;margin:0 0 8px;color:var(--muted)}
  .row{display:flex;gap:28px;flex-wrap:wrap}
  .col{flex:1;min-width:280px}
  .btn{background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{border-color:#4b5563}
  .btn.primary{background:var(--acc);color:#0b1324;border-color:#06b6d4}
  .btn.good{background:var(--good);color:#021407;border-color:#16a34a}
  .btn.warn{background:var(--warn);color:#141002;border-color:#d97706}
  .btn.bad{background:var(--bad);color:#140202;border-color:#dc2626}
  input[type="file"],select{background:#111827;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:6px 8px}
  textarea{width:100%;min-height:320px;background:#0b1020;border:1px solid #243044;border-radius:10px;color:#e5e7eb;padding:10px}

  .small { font-size:12px; color:var(--muted); margin-left:14px; }
  .big { font-size:20px; color:var(--muted); margin-left:14px; }

  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
  .tag.good{background:#093815;color:#7cf39a}
  .tag.bad{background:#3a0d0d;color:#ff9b9b}
  .tag.warn{background:#3a2a0d;color:#ffd28a}
  .tag.warn.ori{background:#093815;color:#7cf39a;margin-right:-5px;font-size:20px}

  #videoWrap{position:relative;max-height:60vh;overflow:auto;border:1px dashed #374151;border-radius:12px}
  #video{max-width:100%;display:block;object-fit:contain}
  /* â‘  ä¿®æ­£ï¼šoverlay æ°¸é é‹ªæ»¿å®¹å™¨ï¼Œä¸å†ç”¨è¦–çª—åº§æ¨™ */
  #overlay{position:absolute;left:0;top:0;width:100%;height:100%;cursor:crosshair}
  #cropBox{position:absolute;border:2px solid var(--acc);background:rgba(34,211,238,.15);display:none}

  /* æ—¥èªŒå€å¡Šæ¨£å¼ï¼šçµ±ä¸€é«˜åº¦ã€å¯æ»¾å‹• */
  .logStack{display:flex;flex-direction:column;gap:8px}
  .logBox{background:#0b1020;border:1px solid #243044;border-radius:10px;padding:10px;max-height:160px;overflow:auto;white-space:pre-wrap}
  .logTitle{font-size:12px;color:var(--muted);margin:0 0 6px 2px}

  .list{display:flex;gap:12px;flex-wrap:wrap}
  .pill{background:#0b1020;border:1px solid #243044;border-radius:999px;padding:6px 10px}
  table{width:100%;border-collapse:collapse}
  td,th{border-bottom:1px solid #2b3549;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>åˆ°å ´åå–®æª¢æŸ¥å™¨ï¼ˆéŠæˆ²éšŠä¼åå–® OCRï¼‰</h1>

  <!-- å¡ç‰‡ä¸€ï¼šåŒ¯å…¥ & å·¦å³æ’ç‰ˆï¼ˆå·¦ï¼šåå–®ï¼›å³ï¼šlog/ocrRawï¼‰ -->
  <div class="card">
    <h2>1ï¸âƒ£ åŒ¯å…¥å ±ååå–®</h2>

    <!-- æ“ä½œåˆ— -->
    <div class="row">
      <div class="col" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <input id="csvInput" type="file" accept=".xlsx,.xls,.csv,.txt" />
        <button class="btn primary" id="btnLoadList">å°å…¥åå–®</button>
        <div class="small">æˆ–ç›´æ¥æŠŠåå–®è²¼åˆ°å·¦å´æ–‡å­—æ¡†ï¼ˆæ¯è¡Œä¸€å€‹æš±ç¨±ï¼‰ã€‚</div>
      </div>
      <div class="col" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <select id="lang">
          <option value="chi_tra+eng">ç¹é«”ä¸­æ–‡ + è‹±æ–‡ï¼ˆå»ºè­°ï¼‰</option>
          <option value="chi_tra">ç¹é«”ä¸­æ–‡</option>
        </select>
        <input id="threshold" type="number" min="0" max="1" step="0.01" value="0.82" style="width:120px" />
        <label class="small">æ¨¡ç³Šæ¯”å°é–€æª»ï¼ˆ0~1, è¶Šå¤§è¶Šåš´æ ¼ï¼‰</label>
      </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ï¼šå…©æ¬„ -->
    <div class="row" style="margin-top:10px;">
      <!-- å·¦æ¬„ï¼šè²¼ä¸Šåå–® -->
      <div class="col">
        <textarea id="manualList" placeholder="å¯åœ¨æ­¤è²¼ä¸Šåå–®ï¼Œæ¯è¡Œä¸€äººï¼›æˆ–ä½¿ç”¨ä¸Šæ–¹æª”æ¡ˆåŒ¯å…¥"></textarea>
        <div class="small" id="rosterCount" style="margin-left:0;margin-top:6px">å°šæœªå°å…¥åå–®</div>
        <div class="small" style="margin-left:0;">å°å…¥å¾Œå¯åœ¨ä¸‹æ–¹çµæœå€æŸ¥çœ‹ã€Œå·²åˆ° / æœªåˆ° / ç›¸ä¼¼ã€ã€‚</div>
      </div>

      <!-- å³æ¬„ï¼šLog èˆ‡ OCR åŸæ–‡ -->
      <div class="col">
        <div class="logStack">
          <div>
            <div class="logTitle">ç³»çµ±æ—¥èªŒ</div>
            <pre class="logBox" id="log"></pre>
          </div>
          <div>
            <div class="logTitle">OCR åŸæ–‡</div>
            <pre class="logBox" id="ocrRaw"></pre>
          </div>
        </div>
        <!-- æˆªåœ–é è¦½ï¼ˆéš±è—ï¼Œç”¨æ–¼ OCRï¼‰ -->
        <canvas id="snap" style="max-width:100%;display:none"></canvas>
        <div class="small" style="margin-left:0;margin-top:6px">æˆªåœ–å®Œæˆå¾Œæœƒé¡¯ç¤ºæ–¼æ­¤å€ï¼ˆè‡ªå‹•éš±è—ï¼ŒOCR ç›´æ¥è®€å–ï¼‰ã€‚</div>
      </div>
    </div>
  </div>

  <!-- å¡ç‰‡äºŒï¼šæ“·å–èˆ‡æ¡†é¸ -->
  <div class="card">
    <h2>2ï¸âƒ£ æ“·å–éŠæˆ²ç•«é¢ä¸¦æ¡†é¸åå–®å€</h2>
    <div class="row">
      <div class="col">
        <button class="btn" id="btnStart">é–‹å§‹æ“·å–</button>
        <button class="btn" id="btnStop" disabled>åœæ­¢æ“·å–</button>
        <button class="btn warn" id="btnOCR" disabled>OCR è¾¨è­˜</button>
      </div>
      <div class="col">
        <span class="tag warn ori">æç¤ºï¼š</span><span class="big">æ¡†é¸éŠæˆ²ä¸­è·¨æœçµ„éšŠä¸­çš„åå–®ã€‚</span>
      </div>
    </div>

    <div id="videoWrap" style="margin-top:10px;">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
      <div id="cropBox"></div>
    </div>
  </div>

  <!-- å¡ç‰‡ä¸‰ï¼šçµæœ -->
  <div class="card">
    <h2>3ï¸âƒ£ çµæœ</h2>
    <div class="row">
      <div class="col">
        <div class="list" id="tags"></div>
      </div>
      <div class="col" style="text-align:right">
        <button class="btn good" id="btnExport" disabled>å°å‡º CSV å ±å‘Š</button>
      </div>
    </div>
    <div style="margin-top:8px;">
      <table>
        <thead><tr><th>ç‹€æ…‹</th><th>å§“å</th><th>å‘½ä¸­å…§å®¹ï¼ˆOCRï¼‰</th><th>ç›¸ä¼¼åº¦</th></tr></thead>
        <tbody id="resultTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ä¾è³´ï¼šPapaParseã€Tesseract.jsï¼ˆCDNï¼‰ -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ========== å·¥å…·ï¼šå­—å…ƒæ­£è¦åŒ– & æ¨¡ç³Šæ¯”å° ========== */
const toHalfWidth = s => s.replace(/[\uFF01-\uFF5E]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/\u3000/g,' ');
const normalize = s => toHalfWidth((s||'').trim().toLowerCase().replace(/\s+/g,'')).replace(/[^\p{Letter}\p{Number}]+/gu,'');
function levenshtein(a,b){
  if(a===b) return 0; if(!a.length) return b.length; if(!b.length) return a.length;
  const v0 = new Array(b.length+1), v1 = new Array(b.length+1);
  for(let i=0;i<v0.length;i++) v0[i]=i;
  for(let i=0;i<a.length;i++){
    v1[0]=i+1;
    for(let j=0;j<b.length;j++){
      const cost = a[i]===b[j]?0:1;
      v1[j+1]=Math.min(v1[j]+1, v0[j+1]+1, v0[j]+cost);
    }
    for(let j=0;j<v0.length;j++) v0[j]=v1[j];
  }
  return v1[b.length];
}
function similarity(a,b){
  a=normalize(a); b=normalize(b);
  if(!a && !b) return 1; if(!a||!b) return 0;
  const dist = levenshtein(a,b);
  const maxLen = Math.max(a.length,b.length);
  return (maxLen - dist) / maxLen;
}

/* ========== ç‹€æ…‹ ========== */
let roster = []; // {name, aliases:[]}
let present = [], absent = [], maybe = [];
let stream = null;
let worker = null;
let selection = null; // {x,y,w,h} ç›¸å°æ–¼ video å¯¦éš›åƒç´ 
let snapCanvas = document.getElementById('snap');
const logEl = document.getElementById('log');
const resultTable = document.getElementById('resultTable');
const tagsEl = document.getElementById('tags');
function log(msg){ logEl.textContent = (msg+'\n'+logEl.textContent).slice(0,5000); }
function setRosterInfo(){ document.getElementById('rosterCount').textContent = roster.length ? `å·²å°å…¥åå–®ï¼š${roster.length} äºº` : 'å°šæœªå°å…¥åå–®'; }

/* ========== åŒ¯å…¥åå–® ========== */
document.getElementById('csvInput').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;

  // ä¾å‰¯æª”åæ±ºå®šè™•ç†æ–¹å¼
  const ext = (file.name.split('.').pop() || '').toLowerCase();

  try {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TXTï¼šä¸€è¡Œä¸€äººï¼ˆç¬¬ä¸€è¡Œå°±æ˜¯ç¬¬ä¸€ç­†ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (ext === 'txt') {
      const text = await file.text();
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      // è½‰æˆ {name, aliases: []}
      const rows = lines.map(n => ({ name: n, aliases: [] }));

      roster = mergeRoster(roster, rows);
      setRosterInfo();
      refreshManualListFromRoster();  // è®“ textarea åŒæ­¥é¡¯ç¤ºç›®å‰åå–®
      log(`âœ… TXT å°å…¥æˆåŠŸï¼š${rows.length} ç­†`);
      return;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Excelï¼š.xlsx / .xls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /*
    if (ext === 'xlsx' || ext === 'xls') {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const sheetName = wb.SheetNames[0];           // å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
      const ws = wb.Sheets[sheetName];

      // è½‰ JSONï¼Œä¿ç•™ç©ºç™½æ¬„ä½
      const json = XLSX.utils.sheet_to_json(ws, { defval: '' });

      // è½‰ç‚º { name, aliases: [] }ï¼›è¡¨é ­æ”¯æ´ï¼šã€Œæš±ç¨± / name / å§“å / ç©å®¶ / player / player nameã€
      const rows = (Array.isArray(json) ? json : []).map((r)=>{
        // æ¬„ä½åæ­£è¦åŒ–ï¼šå»å‰å¾Œç©ºç™½ã€å» BOMã€è½‰å°å¯«
        const nk = (k)=> String(k||'')
          .replace(/^\uFEFF/, '')    // å» BOM
          .trim()
          .toLowerCase();

        // æŠŠ r çš„ key æ­£è¦åŒ–åˆ° rr
        const rr = {};
        for (const k of Object.keys(r)) rr[nk(k)] = r[k];

        const name = (
          rr['name'] ?? rr['æš±ç¨±'] ?? rr['å§“å'] ?? rr['ç©å®¶'] ??
          rr['player'] ?? rr['player name'] ?? ''
        ).toString().trim();

        const aliasField = ( rr['alias'] ?? rr['åˆ¥å'] ?? rr['aliases'] ?? rr['æš±ç¨±åˆ¥å'] ?? '' )
          .toString().trim();
        const aliases = aliasField
          ? aliasField.split('|').map(s => s.trim()).filter(Boolean)
          : [];

        return name ? { name, aliases } : null;
      }).filter(Boolean);

      roster = mergeRoster(roster, rows);
      setRosterInfo();
      refreshManualListFromRoster();  // è®“ textarea åŒæ­¥é¡¯ç¤ºç›®å‰åå–®
      log(`âœ… åŒ¯å…¥æˆåŠŸï¼š${rows.length} ç­†ï¼ˆå·¥ä½œè¡¨ï¼š${sheetName}ï¼‰`);
      return;
    }

    */

    // å…¶ä»–å‰¯æª”åï¼ˆä¸æ”¯æ´ï¼‰
    log('âš ï¸ ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä¸Šå‚³ .xlsx/.xls æˆ– .txt');
  } catch (err) {
    log('åŒ¯å…¥å¤±æ•—ï¼š' + err);
  }
});


function refreshManualListFromRoster() {
  const ta = document.getElementById('manualList');
  // åªé¡¯ç¤ºä¸»åç¨±ï¼›è‹¥æƒ³é€£åˆ¥åä¸€èµ·é¡¯ç¤ºï¼Œå¯æ”¹æˆ `${r.name} | ${r.aliases.join(' | ')}`
  ta.value = roster.map(r => r.name).join('\n');
}

document.getElementById('btnLoadList').addEventListener('click', ()=>{
  const lines = document.getElementById('manualList').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const rows = lines.map(n=>({name:n, aliases:[]}));
  roster = mergeRoster(roster, rows);
    refreshManualListFromRoster();   // â† æ–°å¢é€™è¡Œï¼ˆåŒæ­¥å›æ–‡å­—æ¡†ï¼Œç¢ºä¿å»é‡å¾Œä¹Ÿåæ˜ ï¼‰
  setRosterInfo(); log(`è²¼ä¸Šåå–®å°å…¥ ${rows.length} ç­†`);
});
function mergeRoster(base, add){
  const map = new Map();
  for(const r of base){ map.set(normalize(r.name), {...r}); }
  for(const r of add){
    const key = normalize(r.name); if(!key) continue;
    if(map.has(key)){
      const prev = map.get(key);
      const mergedAliases = Array.from(new Set([...(prev.aliases||[]), ...(r.aliases||[])]));
      map.set(key, { name: prev.name, aliases: mergedAliases });
    } else {
      map.set(key, { name: r.name, aliases: r.aliases||[] });
    }
  }
  return Array.from(map.values());
}

/* ========== æ“·å– + æ¡†é¸ï¼ˆä¿®æ­£ç‰ˆï¼‰ ========== */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const cropBox = document.getElementById('cropBox');
let isDragging=false, startX=0, startY=0;

/* â‘¡ ä¿®æ­£ï¼šoverlay å°ºå¯¸è·Ÿéš¨ video å¯è¦‹å°ºå¯¸ */
function fitOverlay(){
  overlay.width  = video.clientWidth  || 0;
  overlay.height = video.clientHeight || 0;
}
window.addEventListener('resize', fitOverlay);
const obs = new ResizeObserver(()=> fitOverlay());
obs.observe(document.getElementById('videoWrap'));

overlay.addEventListener('mousedown', e=>{
  if(!video.videoWidth) return;
  isDragging=true;
  /* â‘¢ ä¿®æ­£ï¼šç”¨ overlay çš„åº§æ¨™ç³»æ›ç®—æ»‘é¼ ä½ç½® */
  const r = overlay.getBoundingClientRect();
  startX = e.clientX - r.left;
  startY = e.clientY - r.top;
  cropBox.style.display='block';
  cropBox.style.left = startX+'px';
  cropBox.style.top = startY+'px';
  cropBox.style.width='0px';
  cropBox.style.height='0px';
});
overlay.addEventListener('mousemove', e=>{
  if(!isDragging) return;
  const r = overlay.getBoundingClientRect();
  const x = e.clientX - r.left, y = e.clientY - r.top;
  const w = Math.max(1, x - startX), h = Math.max(1, y - startY);
  cropBox.style.width = w+'px'; cropBox.style.height = h+'px';
});
window.addEventListener('mouseup', e=>{
  if(!isDragging) return;
  isDragging = false;

  // é¡¯ç¤ºå°ºå¯¸
  const dispW = overlay.width, dispH = overlay.height;
  const vidW = video.videoWidth, vidH = video.videoHeight;

  const x = parseInt(cropBox.style.left), y = parseInt(cropBox.style.top);
  const w = parseInt(cropBox.style.width), h = parseInt(cropBox.style.height);

  const scaleX = vidW / dispW;
  const scaleY = vidH / dispH;

  selection = {
    x: Math.round(x * scaleX),
    y: Math.round(y * scaleY),
    w: Math.round(w * scaleX),
    h: Math.round(h * scaleY)
  };
  log(`å·²é¸ç¯„åœï¼ˆå¯¦éš›åƒç´ ï¼‰ï¼š${selection.x},${selection.y},${selection.w}x${selection.h}`);
});


document.getElementById('btnStart').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getDisplayMedia({ video: { displaySurface:"window" }, audio:false });
    video.srcObject = stream;
    video.onloadedmetadata = ()=>{ video.play(); fitOverlay(); };
    document.getElementById('btnStop').disabled = false;
    document.getElementById('btnOCR').disabled = false; // â† æ–°å¢
    overlay.style.display='block';
    log('æ“·å–å·²å•Ÿå‹•ã€‚è«‹æŠŠéŠæˆ²è¦–çª—åˆ‡åˆ°ä½ å‰›é¸çš„ä¾†æºä¸Šã€‚');
  }catch(err){ log('æ“·å–è¢«æ‹’æˆ–å¤±æ•—ï¼š'+err); }
});
document.getElementById('btnStop').addEventListener('click', ()=>{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video.srcObject = null; cropBox.style.display='none'; selection=null;
  document.getElementById('btnStop').disabled = true;
  document.getElementById('btnOCR').disabled = true;
  log('å·²åœæ­¢æ“·å–ã€‚');
});


/* ========== å½±åƒå‰è™•ç†ï¼ˆç°éš + è‡ªé©æ‡‰äºŒå€¼ï¼‰ ========== */
function preprocessCrop(srcCanvas, sel){
  const {x,y,w,h} = sel || {x:0,y:0,w:srcCanvas.width,h:srcCanvas.height};
  const out = document.createElement('canvas'); out.width = w; out.height = h;
  const ctx = out.getContext('2d'); ctx.drawImage(srcCanvas, x,y,w,h, 0,0,w,h);
  const img = ctx.getImageData(0,0,w,h); const d = img.data;
  // ç°éš
  for(let i=0;i<d.length;i+=4){
    const gray = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114)|0;
    d[i]=d[i+1]=d[i+2]=gray;
  }
  // è‡ªé©æ‡‰äºŒå€¼ï¼ˆå±€éƒ¨å¹³å‡ + Cï¼‰
  const win = 15, half = (win/2)|0, C = 8;
  const W = w, H = h;
  const integ = new Uint32Array((W+1)*(H+1));
  for(let y1=1;y1<=H;y1++){
    let rowsum=0;
    for(let x1=1;x1<=W;x1++){
      const gray = d[((y1-1)*W + (x1-1))*4];
      rowsum += gray;
      integ[y1*(W+1)+x1] = integ[(y1-1)*(W+1)+x1] + rowsum;
    }
  }
  const outImg = ctx.createImageData(w,h); const od = outImg.data;
  for(let y2=0;y2<H;y2++){
    for(let x2=0;x2<W;x2++){
      const x0 = Math.max(0, x2-half), y0 = Math.max(0, y2-half);
      const x3 = Math.min(W-1, x2+half), y3 = Math.min(H-1, y2+half);
      const A = x0, B = y0, Cc = x3, Dd = y3;
      const sum = integ[(Dd+1)*(W+1)+(Cc+1)] - integ[(B)*(W+1)+(Cc+1)] - integ[(Dd+1)*(W+1)+(A)] + integ[(B)*(W+1)+(A)];
      const count = (Cc-A+1)*(Dd-B+1);
      const gray = d[(y2*W+x2)*4];
      const thresh = (sum/count) - C;
      const v = gray > thresh ? 255 : 0;
      const idx = (y2*W+x2)*4; od[idx]=od[idx+1]=od[idx+2]=v; od[idx+3]=255;
    }
  }
  ctx.putImageData(outImg,0,0);
  return out;
}

/* ========== OCR æµç¨‹ ========== */
async function ensureWorker(){
  if(worker) return worker;
  const lang = document.getElementById('lang').value || 'chi_tra+eng';
  worker = await Tesseract.createWorker(lang, 1, {
    logger: m => { if(m.status==='recognizing text'){ log(`OCR é€²åº¦ï¼š${Math.round((m.progress||0)*100)}%`); } }
  });
  log('OCR èªè¨€è¼‰å…¥å®Œæˆï¼š'+lang);
  return worker;
}

function snapOnce() {
  if (!video.videoWidth) { log('å°šæœªé–‹å§‹æ“·å–'); return false; }
  const c = snapCanvas;
  c.width = video.videoWidth;
  c.height = video.videoHeight;
  const g = c.getContext('2d');
  g.drawImage(video, 0, 0);
  log('å·²æ‹æ”æˆªåœ–ã€‚');
  return true;
}

document.getElementById('btnOCR').addEventListener('click', async ()=>{
  try{
   // å…ˆè‡ªå‹•æ‹ç…§ï¼ˆç¢ºä¿æ˜¯æœ€æ–°ç•«é¢ï¼‰
    if (!snapOnce()) return;
    const sel = selection || {x:0,y:0,w:snapCanvas.width,h:snapCanvas.height};
    const proc = preprocessCrop(snapCanvas, sel);

    await ensureWorker();
    const t0 = performance.now();
    const { data } = await worker.recognize(proc);

// ğŸ”¹ ç›´æ¥æŠŠå®Œæ•´æ–‡å­—å¡é€²é è¦½æ¡†
const ocrRawEl = document.getElementById('ocrRaw');
ocrRawEl.textContent = (data.text || '').trim() || '(ç©ºç™½)';

// ğŸ”¹ è‹¥ data.text ç‚ºç©ºï¼Œå†å˜—è©¦ç”¨ lines æ‹¼å‡ºä¾†ï¼ˆä¿åº•ï¼‰
if (!ocrRawEl.textContent || ocrRawEl.textContent === '(ç©ºç™½)') {
  try {
    const lines = (data.lines || []).map(l => (l.text || '').trim()).filter(Boolean);
    if (lines.length) ocrRawEl.textContent = lines.join('\n');
  } catch {}
}

// ğŸ”¹ åŒæ­¥åœ¨ console çœ‹å®Œæ•´ç‰©ä»¶ï¼ˆæ–¹ä¾¿ä½ æ’æŸ¥ï¼‰
console.log('Tesseract data =', data);
    const t1 = performance.now();
    log(`OCR å®Œæˆï¼Œç”¨æ™‚ ${(t1-t0).toFixed(0)} ms`);

    const lines = (data.text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    log('OCR è¡Œæ•¸ï¼š'+lines.length);
    evaluatePresence(lines);
  }catch(err){
    log('OCR ç™¼ç”ŸéŒ¯èª¤ï¼š'+err);
  }
});

/* ========== æ¯”å°æ±ºç­– ========== */
function evaluatePresence(ocrLines){
  const thr = parseFloat(document.getElementById('threshold').value)||0.82;
  present = []; absent = []; maybe = [];
  const ocrSet = new Set(ocrLines);

  function matchOne(target, candidates){
    let best = { line:'', score:0 };
    for(const c of candidates){
      const s = similarity(target, c);
      if(s > best.score) best = {line:c, score:s};
      if(s >= 0.999) return {line:c, score:s, early:true};
    }
    return best;
  }

  for(const r of roster){
    const names = [r.name, ...(r.aliases||[])].filter(Boolean);
    let best = { line:'', score:0 };
    for(const n of names){
      const m = matchOne(n, ocrSet);
      if(m.early){ best = m; break; }
      if(m.score > best.score) best = m;
    }
    if(best.score >= thr){
      present.push({ name:r.name, hit:best.line, score:best.score });
    }else if(best.score >= Math.max(0.6, thr-0.12)){
      maybe.push({ name:r.name, hit:best.line, score:best.score });
    }else{
      absent.push({ name:r.name, hit:'', score:0 });
    }
  }
  renderResults();
}

/* ========== å‘ˆç¾ & åŒ¯å‡º ========== */
function renderResults(){
  tagsEl.innerHTML = `
    <span class="tag good">å·²åˆ°ï¼š${present.length}</span>
    <span class="tag bad">æœªåˆ°ï¼š${absent.length}</span>
    <span class="tag warn">ç›¸ä¼¼ï¼š${maybe.length}</span>
  `;
  resultTable.innerHTML = '';
  const rows = [
    ...present.map(x=>({status:'å·²åˆ°', cls:'good', ...x})),
    ...maybe.map(x=>({status:'ç›¸ä¼¼', cls:'warn', ...x})),
    ...absent.map(x=>({status:'æœªåˆ°', cls:'bad', ...x})),
  ];
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><span class="tag ${r.cls}">${r.status}</span></td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.hit||'')}</td>
      <td>${(r.score*100).toFixed(0)}%</td>`;
    resultTable.appendChild(tr);
  }
  document.getElementById('btnExport').disabled = rows.length===0;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])) }

document.getElementById('btnExport').addEventListener('click', ()=>{
  const rows = [
    ['status','name','ocr_hit','similarity'],
    ...present.map(x=>['present', x.name, x.hit, x.score.toFixed(4)]),
    ...maybe.map(x=>['maybe', x.name, x.hit, x.score.toFixed(4)]),
    ...absent.map(x=>['absent', x.name, '', '0.0000']),
  ];
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `attendance_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  a.click();
});
</script>
</body>
</html>
