<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>到場名單檢查器｜OCR</title>
<style>
  :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
  html,body {
    height:100%;
    background:var(--bg);
    color:var(--ink);
    font-family:"Microsoft JhengHei", "微軟正黑體", sans-serif;
  }

  .wrap{max-width:1200px;margin:20px auto;padding:16px}
  .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-bottom:16px}
  h1{font-size:22px;margin:0 0 8px}
  h2{font-size:18px;margin:0 0 8px;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:280px}
  .btn{background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{border-color:#4b5563}
  .btn.primary{background:var(--acc);color:#0b1324;border-color:#06b6d4}
  .btn.good{background:var(--good);color:#021407;border-color:#16a34a}
  .btn.warn{background:var(--warn);color:#141002;border-color:#d97706}
  .btn.bad{background:var(--bad);color:#140202;border-color:#dc2626}
  input[type="file"],select{background:#111827;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:6px 8px}
  textarea{width:100%;min-height:120px;background:#0b1020;border:1px solid #243044;border-radius:10px;color:#e5e7eb;padding:10px}
.small {
  font-size:12px;
  color:var(--muted);
  margin-left:14px;
}

  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
  .tag.good{background:#093815;color:#7cf39a}
  .tag.bad{background:#3a0d0d;color:#ff9b9b}
  .tag.warn{background:#3a2a0d;color:#ffd28a}
  #videoWrap{position:relative;max-height:60vh;overflow:auto;border:1px dashed #374151;border-radius:12px}
  #video{max-width:100%;display:block;object-fit:contain}
  /* ① 修正：overlay 永遠鋪滿容器，不再用視窗座標 */
  #overlay{position:absolute;left:0;top:0;width:100%;height:100%;cursor:crosshair}
  #cropBox{position:absolute;border:2px solid var(--acc);background:rgba(34,211,238,.15);display:none}
  pre.log{white-space:pre-wrap;background:#0b1020;border:1px solid #243044;padding:10px;border-radius:10px;max-height:200px;overflow:auto}
  .list{display:flex;gap:12px;flex-wrap:wrap}
  .pill{background:#0b1020;border:1px solid #243044;border-radius:999px;padding:6px 10px}
  table{width:100%;border-collapse:collapse}
  td,th{border-bottom:1px solid #2b3549;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>到場名單檢查器（遊戲隊伍名單 OCR）</h1>
  <div class="card">
    <h2>① 匯入報名名單</h2>
    <div class="row">
      <div class="col">
        <input id="csvInput" type="file" accept=".xlsx,.xls,.csv,.txt" />
        <button class="btn primary" id="btnLoadList">導入名單</button>
        <div class="small">CSV 欄位建議：<code>name</code>（必填）</div>
        <div class="small">或直接把名單貼到右邊文字框（每行一個暱稱）。</div>
      </div>
      <div class="col">
        <select id="lang">
          <option value="chi_tra+eng">繁體中文 + 英文（建議）</option>
          <option value="chi_tra">繁體中文</option>
          <option value="eng">英文</option>
        </select>
        <input id="threshold" type="number" min="0" max="1" step="0.01" value="0.82" style="width:120px" />
        <label class="small">模糊比對門檻（0~1, 越大越嚴格）</label>
      </div>
    </div>
    <div class="row">
      <div class="col"><textarea id="manualList" placeholder="可在此貼上名單，每行一人；或使用 CSV 匯入"></textarea></div>
      <div class="col">
        <div class="small" id="rosterCount">尚未導入名單</div>
        <div class="small">導入後可在下方結果區查看「已到 / 未到 / 可疑」。</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>② 擷取遊戲畫面並框選名單區</h2>
    <div class="row">
      <div class="col">
        <button class="btn" id="btnStart">開始擷取</button>
        <button class="btn" id="btnStop" disabled>停止擷取</button>
        <button class="btn" id="btnSnap" disabled>拍攝截圖</button>
        <button class="btn warn" id="btnOCR" disabled>OCR 辨識</button>
      </div>
      <div class="col">
        <span class="tag warn">提示：</span><span class="small">框選遊戲中跨服組隊中的名單。</span>
      </div>
    </div>

    <div id="videoWrap" style="margin-top:10px;">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
      <div id="cropBox"></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div class="col">
        <canvas id="snap" style="max-width:100%;display:none"></canvas>
        <div class="small">截圖完成後會顯示於此區（自動隱藏，OCR 直接讀取）。</div>
      </div>
      <div class="col">
        <pre class="log" id="log"></pre>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>③ 結果</h2>
    <div class="row">
      <div class="col">
        <div class="list" id="tags"></div>
      </div>
      <div class="col" style="text-align:right">
        <button class="btn good" id="btnExport" disabled>導出 CSV 報告</button>
      </div>
    </div>
    <div style="margin-top:8px;">
      <table>
        <thead><tr><th>狀態</th><th>姓名</th><th>命中內容（OCR）</th><th>相似度</th></tr></thead>
        <tbody id="resultTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 依賴：PapaParse、Tesseract.js（CDN） -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ========== 工具：字元正規化 & 模糊比對 ========== */
const toHalfWidth = s => s.replace(/[\uFF01-\uFF5E]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/\u3000/g,' ');
const normalize = s => toHalfWidth((s||'').trim().toLowerCase().replace(/\s+/g,'')).replace(/[^\p{Letter}\p{Number}]+/gu,'');
function levenshtein(a,b){
  if(a===b) return 0; if(!a.length) return b.length; if(!b.length) return a.length;
  const v0 = new Array(b.length+1), v1 = new Array(b.length+1);
  for(let i=0;i<v0.length;i++) v0[i]=i;
  for(let i=0;i<a.length;i++){
    v1[0]=i+1;
    for(let j=0;j<b.length;j++){
      const cost = a[i]===b[j]?0:1;
      v1[j+1]=Math.min(v1[j]+1, v0[j+1]+1, v0[j]+cost);
    }
    for(let j=0;j<v0.length;j++) v0[j]=v1[j];
  }
  return v1[b.length];
}
function similarity(a,b){
  a=normalize(a); b=normalize(b);
  if(!a && !b) return 1; if(!a||!b) return 0;
  const dist = levenshtein(a,b);
  const maxLen = Math.max(a.length,b.length);
  return (maxLen - dist) / maxLen;
}

/* ========== 狀態 ========== */
let roster = []; // {name, aliases:[]}
let present = [], absent = [], maybe = [];
let stream = null;
let worker = null;
let selection = null; // {x,y,w,h} 相對於 video 實際像素
let snapCanvas = document.getElementById('snap');
const logEl = document.getElementById('log');
const resultTable = document.getElementById('resultTable');
const tagsEl = document.getElementById('tags');
function log(msg){ logEl.textContent = (msg+'\n'+logEl.textContent).slice(0,5000); }
function setRosterInfo(){ document.getElementById('rosterCount').textContent = roster.length ? `已導入名單：${roster.length} 人` : '尚未導入名單'; }

/* ========== 匯入名單 ========== */
document.getElementById('csvInput').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;

  // 依副檔名決定處理方式
  const ext = (file.name.split('.').pop() || '').toLowerCase();

  try {
    // ───────────────────────────────── TXT：一行一人（第一行就是第一筆） ─────────────────────────────────
    if (ext === 'txt') {
      const text = await file.text();
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      // 轉成 {name, aliases: []}
      const rows = lines.map(n => ({ name: n, aliases: [] }));

      roster = mergeRoster(roster, rows);
      setRosterInfo();
      refreshManualListFromRoster();  // 讓 textarea 同步顯示目前名單
      log(`✅ TXT 導入成功：${rows.length} 筆`);
      return;
    }

    // ───────────────────────────────── Excel：.xlsx / .xls ─────────────────────────────────
    if (ext === 'xlsx' || ext === 'xls') {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const sheetName = wb.SheetNames[0];           // 取第一個工作表
      const ws = wb.Sheets[sheetName];

      // 轉 JSON，保留空白欄位
      const json = XLSX.utils.sheet_to_json(ws, { defval: '' });

      // 轉為 { name, aliases: [] }；表頭支援：「暱稱 / name / 姓名 / 玩家 / player / player name」
      const rows = (Array.isArray(json) ? json : []).map((r)=>{
        // 欄位名正規化：去前後空白、去 BOM、轉小寫
        const nk = (k)=> String(k||'')
          .replace(/^\uFEFF/, '')    // 去 BOM
          .trim()
          .toLowerCase();

        // 把 r 的 key 正規化到 rr
        const rr = {};
        for (const k of Object.keys(r)) rr[nk(k)] = r[k];

        const name = (
          rr['name'] ?? rr['暱稱'] ?? rr['姓名'] ?? rr['玩家'] ??
          rr['player'] ?? rr['player name'] ?? ''
        ).toString().trim();

        const aliasField = ( rr['alias'] ?? rr['別名'] ?? rr['aliases'] ?? rr['暱稱別名'] ?? '' )
          .toString().trim();
        const aliases = aliasField
          ? aliasField.split('|').map(s => s.trim()).filter(Boolean)
          : [];

        return name ? { name, aliases } : null;
      }).filter(Boolean);

      roster = mergeRoster(roster, rows);
      setRosterInfo();
      refreshManualListFromRoster();  // 讓 textarea 同步顯示目前名單
      log(`✅ 匯入成功：${rows.length} 筆（工作表：${sheetName}）`);
      return;
    }

    // 其他副檔名（不支援）
    log('⚠️ 不支援的檔案格式，請上傳 .xlsx/.xls 或 .txt');
  } catch (err) {
    log('匯入失敗：' + err);
  }
});


function refreshManualListFromRoster() {
  const ta = document.getElementById('manualList');
  // 只顯示主名稱；若想連別名一起顯示，可改成 `${r.name} | ${r.aliases.join(' | ')}`
  ta.value = roster.map(r => r.name).join('\n');
}

document.getElementById('btnLoadList').addEventListener('click', ()=>{
  const lines = document.getElementById('manualList').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const rows = lines.map(n=>({name:n, aliases:[]}));
  roster = mergeRoster(roster, rows);
    refreshManualListFromRoster();   // ← 新增這行（同步回文字框，確保去重後也反映）
  setRosterInfo(); log(`貼上名單導入 ${rows.length} 筆`);
});
function mergeRoster(base, add){
  const map = new Map();
  for(const r of base){ map.set(normalize(r.name), {...r}); }
  for(const r of add){
    const key = normalize(r.name); if(!key) continue;
    if(map.has(key)){
      const prev = map.get(key);
      const mergedAliases = Array.from(new Set([...(prev.aliases||[]), ...(r.aliases||[])]));
      map.set(key, { name: prev.name, aliases: mergedAliases });
    } else {
      map.set(key, { name: r.name, aliases: r.aliases||[] });
    }
  }
  return Array.from(map.values());
}

/* ========== 擷取 + 框選（修正版） ========== */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const cropBox = document.getElementById('cropBox');
let isDragging=false, startX=0, startY=0;

/* ② 修正：overlay 尺寸跟隨 video 可見尺寸 */
function fitOverlay(){
  overlay.width  = video.clientWidth  || 0;
  overlay.height = video.clientHeight || 0;
}
window.addEventListener('resize', fitOverlay);
const obs = new ResizeObserver(()=> fitOverlay());
obs.observe(document.getElementById('videoWrap'));

overlay.addEventListener('mousedown', e=>{
  if(!video.videoWidth) return;
  isDragging=true;
  /* ③ 修正：用 overlay 的座標系換算滑鼠位置 */
  const r = overlay.getBoundingClientRect();
  startX = e.clientX - r.left;
  startY = e.clientY - r.top;
  cropBox.style.display='block';
  cropBox.style.left = startX+'px';
  cropBox.style.top = startY+'px';
  cropBox.style.width='0px';
  cropBox.style.height='0px';
});
overlay.addEventListener('mousemove', e=>{
  if(!isDragging) return;
  const r = overlay.getBoundingClientRect();
  const x = e.clientX - r.left, y = e.clientY - r.top;
  const w = Math.max(1, x - startX), h = Math.max(1, y - startY);
  cropBox.style.width = w+'px'; cropBox.style.height = h+'px';
});
window.addEventListener('mouseup', e=>{
  if(!isDragging) return;
  isDragging = false;

  // 顯示尺寸
  const dispW = overlay.width, dispH = overlay.height;
  const vidW = video.videoWidth, vidH = video.videoHeight;

  const x = parseInt(cropBox.style.left), y = parseInt(cropBox.style.top);
  const w = parseInt(cropBox.style.width), h = parseInt(cropBox.style.height);

  const scaleX = vidW / dispW;
  const scaleY = vidH / dispH;

  selection = {
    x: Math.round(x * scaleX),
    y: Math.round(y * scaleY),
    w: Math.round(w * scaleX),
    h: Math.round(h * scaleY)
  };
  log(`已選範圍（實際像素）：${selection.x},${selection.y},${selection.w}x${selection.h}`);
});


document.getElementById('btnStart').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getDisplayMedia({ video: { displaySurface:"window" }, audio:false });
    video.srcObject = stream;
    video.onloadedmetadata = ()=>{ video.play(); fitOverlay(); };
    document.getElementById('btnStop').disabled = false;
    document.getElementById('btnSnap').disabled = false;
    overlay.style.display='block';
    log('擷取已啟動。請把遊戲視窗切到你剛選的來源上。');
  }catch(err){ log('擷取被拒或失敗：'+err); }
});
document.getElementById('btnStop').addEventListener('click', ()=>{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video.srcObject = null; cropBox.style.display='none'; selection=null;
  document.getElementById('btnStop').disabled = true;
  document.getElementById('btnSnap').disabled = true;
  document.getElementById('btnOCR').disabled = true;
  log('已停止擷取。');
});
document.getElementById('btnSnap').addEventListener('click', ()=>{
  if(!video.videoWidth){ log('尚未開始擷取'); return; }
  const c = snapCanvas; c.width = video.videoWidth; c.height = video.videoHeight;
  const g = c.getContext('2d'); g.drawImage(video, 0,0);
  document.getElementById('btnOCR').disabled = false;
  log('已拍攝截圖。若尚未框選，請拖曳選取名單區再按 OCR。');
});

/* ========== 影像前處理（灰階 + 自適應二值） ========== */
function preprocessCrop(srcCanvas, sel){
  const {x,y,w,h} = sel || {x:0,y:0,w:srcCanvas.width,h:srcCanvas.height};
  const out = document.createElement('canvas'); out.width = w; out.height = h;
  const ctx = out.getContext('2d'); ctx.drawImage(srcCanvas, x,y,w,h, 0,0,w,h);
  const img = ctx.getImageData(0,0,w,h); const d = img.data;
  // 灰階
  for(let i=0;i<d.length;i+=4){
    const gray = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114)|0;
    d[i]=d[i+1]=d[i+2]=gray;
  }
  // 自適應二值（局部平均 + C）
  const win = 15, half = (win/2)|0, C = 8;
  const W = w, H = h;
  const integ = new Uint32Array((W+1)*(H+1));
  for(let y1=1;y1<=H;y1++){
    let rowsum=0;
    for(let x1=1;x1<=W;x1++){
      const gray = d[((y1-1)*W + (x1-1))*4];
      rowsum += gray;
      integ[y1*(W+1)+x1] = integ[(y1-1)*(W+1)+x1] + rowsum;
    }
  }
  const outImg = ctx.createImageData(w,h); const od = outImg.data;
  for(let y2=0;y2<H;y2++){
    for(let x2=0;x2<W;x2++){
      const x0 = Math.max(0, x2-half), y0 = Math.max(0, y2-half);
      const x3 = Math.min(W-1, x2+half), y3 = Math.min(H-1, y2+half);
      const A = x0, B = y0, Cc = x3, Dd = y3;
      const sum = integ[(Dd+1)*(W+1)+(Cc+1)] - integ[(B)*(W+1)+(Cc+1)] - integ[(Dd+1)*(W+1)+(A)] + integ[(B)*(W+1)+(A)];
      const count = (Cc-A+1)*(Dd-B+1);
      const gray = d[(y2*W+x2)*4];
      const thresh = (sum/count) - C;
      const v = gray > thresh ? 255 : 0;
      const idx = (y2*W+x2)*4; od[idx]=od[idx+1]=od[idx+2]=v; od[idx+3]=255;
    }
  }
  ctx.putImageData(outImg,0,0);
  return out;
}

/* ========== OCR 流程 ========== */
async function ensureWorker(){
  if(worker) return worker;
  const lang = document.getElementById('lang').value || 'chi_tra+eng';
  worker = await Tesseract.createWorker(lang, 1, {
    logger: m => { if(m.status==='recognizing text'){ log(`OCR 進度：${Math.round((m.progress||0)*100)}%`); } }
  });
  log('OCR 語言載入完成：'+lang);
  return worker;
}

document.getElementById('btnOCR').addEventListener('click', async ()=>{
  try{
    if(!roster.length){ alert('請先導入報名名單'); return; }
    if(!snapCanvas.width){ alert('請先拍攝截圖'); return; }
    const sel = selection || {x:0,y:0,w:snapCanvas.width,h:snapCanvas.height};
    const proc = preprocessCrop(snapCanvas, sel);

    await ensureWorker();
    const t0 = performance.now();
    const { data } = await worker.recognize(proc);
    const t1 = performance.now();
    log(`OCR 完成，用時 ${(t1-t0).toFixed(0)} ms`);

    const lines = (data.text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    log('OCR 行數：'+lines.length);
    evaluatePresence(lines);
  }catch(err){
    log('OCR 發生錯誤：'+err);
  }
});

/* ========== 比對決策 ========== */
function evaluatePresence(ocrLines){
  const thr = parseFloat(document.getElementById('threshold').value)||0.82;
  present = []; absent = []; maybe = [];
  const ocrSet = new Set(ocrLines);

  function matchOne(target, candidates){
    let best = { line:'', score:0 };
    for(const c of candidates){
      const s = similarity(target, c);
      if(s > best.score) best = {line:c, score:s};
      if(s >= 0.999) return {line:c, score:s, early:true};
    }
    return best;
  }

  for(const r of roster){
    const names = [r.name, ...(r.aliases||[])].filter(Boolean);
    let best = { line:'', score:0 };
    for(const n of names){
      const m = matchOne(n, ocrSet);
      if(m.early){ best = m; break; }
      if(m.score > best.score) best = m;
    }
    if(best.score >= thr){
      present.push({ name:r.name, hit:best.line, score:best.score });
    }else if(best.score >= Math.max(0.6, thr-0.12)){
      maybe.push({ name:r.name, hit:best.line, score:best.score });
    }else{
      absent.push({ name:r.name, hit:'', score:0 });
    }
  }
  renderResults();
}

/* ========== 呈現 & 匯出 ========== */
function renderResults(){
  tagsEl.innerHTML = `
    <span class="tag good">已到：${present.length}</span>
    <span class="tag bad">未到：${absent.length}</span>
    <span class="tag warn">可疑：${maybe.length}</span>
  `;
  resultTable.innerHTML = '';
  const rows = [
    ...present.map(x=>({status:'已到', cls:'good', ...x})),
    ...maybe.map(x=>({status:'可疑', cls:'warn', ...x})),
    ...absent.map(x=>({status:'未到', cls:'bad', ...x})),
  ];
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><span class="tag ${r.cls}">${r.status}</span></td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.hit||'')}</td>
      <td>${(r.score*100).toFixed(0)}%</td>`;
    resultTable.appendChild(tr);
  }
  document.getElementById('btnExport').disabled = rows.length===0;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])) }

document.getElementById('btnExport').addEventListener('click', ()=>{
  const rows = [
    ['status','name','ocr_hit','similarity'],
    ...present.map(x=>['present', x.name, x.hit, x.score.toFixed(4)]),
    ...maybe.map(x=>['maybe', x.name, x.hit, x.score.toFixed(4)]),
    ...absent.map(x=>['absent', x.name, '', '0.0000']),
  ];
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `attendance_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  a.click();
});
</script>
</body>
</html>
